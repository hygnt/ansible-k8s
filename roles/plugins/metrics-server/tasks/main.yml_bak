- name: Create The Metrics-Server Directory On The Master1 Node
  file:
    path: /etc/kubernetes/metrics-server
    state: directory
    mode: '0755'

- name: Send Metrics-Server Config Templates To The Master1 Node
  template: src={{ item }}.j2 dest=/etc/kubernetes/metrics-server/{{ item }}
  with_items:
  - aggregated-metrics-reader.yaml
  - auth-delegator.yaml
  - auth-reader.yaml
  - metrics-apiservice.yaml
  - metrics-server-deployment.yaml
  - metrics-server-service.yaml
  - resource-reader.yaml

- name: Check The Metrics-Server Pod Whether Exist For The K8S Cluster
  shell: kubectl get pod --all-namespaces -o wide | grep 'metrics-server' | awk '{print $4}'
  register: metric_pod_statu

- name: Deployment Metrics-Server For The K8S Cluster
  shell: kubectl apply -f /etc/kubernetes/metrics-server/.
  when: '"Running" not in metric_pod_statu.stdout'

- name: 轮询等待 Metrics-Server Pod 运行
  shell: kubectl get pod --all-namespaces -o wide | grep 'metrics-server' | awk '{print $4}'
  register: pod_status
  until: "'Running' in pod_status.stdout"
  retries: 10
  delay: 5
  ignore_errors: True
